<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Step Scientists - Complete with Google Fit</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Color Emoji', 'Apple Color Emoji', 'Segoe UI Emoji', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            margin: 0;
            padding: 20px;
        }
        
        .app { max-width: 400px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        
        .connection-status {
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .connected { background: rgba(76, 175, 80, 0.3); }
        .disconnected { background: rgba(244, 67, 54, 0.3); }
        .connecting { background: rgba(255, 152, 0, 0.3); }
        
        .google-fit-status {
            padding: 8px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 15px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .step-display {
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .step-count { font-size: 48px; font-weight: bold; margin-bottom: 10px; }
        
        .mode-display {
            background: rgba(255,255,255,0.15);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .resources {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .resource {
            background: rgba(255,255,255,0.15);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .resource-value { font-size: 24px; font-weight: bold; }
        .resource-label { font-size: 12px; opacity: 0.8; }
        
        .buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .btn:active {
            background: rgba(255,255,255,0.4);
            transform: scale(0.95);
        }
        
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: rgba(76, 175, 80, 0.8); }
        .btn-secondary { background: rgba(33, 150, 243, 0.8); }
        .btn-warning { background: rgba(255, 193, 7, 0.8); }
        
        .section {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .card {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
        }
        
        .card:active { background: rgba(255,255,255,0.2); }
        
        .emoji { font-size: 24px; margin-bottom: 5px; }
        .name { font-size: 12px; }
        
        .log {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
            font-family: monospace;
            max-height: 100px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="header">
            <h1>üß™ Step Scientists</h1>
            <div id="connection-status" class="connection-status connecting">Connecting...</div>
            <div id="google-fit-status" class="google-fit-status disconnected" onclick="connectGoogleFit()">
                üè• Tap to connect Google Fit
            </div>
        </div>
        
        <div class="step-display">
            <div id="step-count" class="step-count">0</div>
            <div>Steps Today</div>
        </div>
        
        <div class="mode-display">
            <div id="mode-title">üîç Discovery Mode</div>
            <div id="mode-desc">1000 steps = 1 cell</div>
        </div>
        
        <div class="resources">
            <div class="resource">
                <div id="cells" class="resource-value">0</div>
                <div class="resource-label">Cells</div>
            </div>
            <div class="resource">
                <div id="exp" class="resource-value">0</div>
                <div class="resource-label">Experience</div>
            </div>
            <div class="resource">
                <div id="glass" class="resource-value">0</div>
                <div class="resource-label">üîç Glass</div>
            </div>
        </div>
        
        <div class="buttons">
            <button class="btn btn-primary" onclick="addSteps()">+100 Steps</button>
            <button class="btn btn-secondary" onclick="switchMode()">Switch Mode</button>
            <button class="btn" onclick="inspectCell()" id="inspect-btn">Inspect Cell</button>
            <button class="btn" onclick="toggleMagnifyingGlass()" id="glass-btn">Use üîç Glass</button>
            <button class="btn" onclick="viewSteplings()">View Steplings</button>
            <button class="btn" onclick="syncSteps()">Sync Steps</button>
        </div>
        
        <div id="species-section" class="section">
            <h3>Species Collection</h3>
            <div id="species-grid" class="grid">
                <div class="card">Loading...</div>
            </div>
        </div>
        
        <div id="steplings-section" class="section" style="display: none;">
            <h3>My Steplings</h3>
            <div id="steplings-grid" class="grid">
                <div class="card">Loading...</div>
            </div>
            <div style="text-align: center; margin-top: 15px;">
                <button class="btn" onclick="hideSteplings()">Back</button>
                <button class="btn btn-secondary" onclick="loadSteplings()">Refresh</button>
            </div>
        </div>
        
        <div id="log" class="log">Step Scientists loading...</div>
    </div>

    <script>
        const API_BASE = 'http://192.168.1.111:3000';
        const GOOGLE_FIT_CLIENT_ID = '570511343860-48hgn66bnn5vjdsvb3m62m4qpinbfl9n.apps.googleusercontent.com';
        
        var game = {
            steps: 0,
            mode: 'discovery',
            cells: 0,
            experience: 0,
            magnifyingGlass: 0,
            discoveredSpecies: [],
            milestonesReached: []
        };
        
        var allSpecies = [];
        var playerSteplings = [];
        var isConnected = false;
        var useMagnifyingGlass = false;
        
        // Google Fit integration
        var googleFitService = {
            initialized: false,
            authorized: false,
            accessToken: null,
            
            async initialize() {
                try {
                    // Load Google Identity Services
                    if (!window.google?.accounts) {
                        await this.loadScript('https://accounts.google.com/gsi/client');
                    }
                    if (!window.gapi) {
                        await this.loadScript('https://apis.google.com/js/api.js');
                    }
                    
                    // Initialize gapi client
                    await new Promise((resolve) => {
                        window.gapi.load('client', async () => {
                            await window.gapi.client.init({
                                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/fitness/v1/rest'],
                            });
                            resolve();
                        });
                    });
                    
                    this.initialized = true;
                    updateGoogleFitStatus();
                    return true;
                } catch (error) {
                    log('Google Fit init failed: ' + error.message);
                    return false;
                }
            },
            
            loadScript(src) {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = src;
                    script.async = true;
                    script.defer = true;
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
            },
            
            async authorize() {
                if (!this.initialized) {
                    await this.initialize();
                }
                
                return new Promise((resolve) => {
                    const tokenClient = window.google.accounts.oauth2.initTokenClient({
                        client_id: GOOGLE_FIT_CLIENT_ID,
                        scope: 'https://www.googleapis.com/auth/fitness.activity.read',
                        callback: (tokenResponse) => {
                            this.accessToken = tokenResponse.access_token;
                            this.authorized = true;
                            updateGoogleFitStatus();
                            log('‚úÖ Google Fit connected!');
                            resolve(true);
                        },
                    });
                    
                    tokenClient.requestAccessToken();
                });
            },
            
            async getStepsToday() {
                if (!this.authorized || !this.accessToken) {
                    return 0;
                }
                
                try {
                    const today = new Date();
                    const startOfDay = new Date(today);
                    startOfDay.setHours(0, 0, 0, 0);
                    
                    const endOfDay = new Date(today);
                    endOfDay.setHours(23, 59, 59, 999);

                    const request = {
                        aggregateBy: [{
                            dataTypeName: 'com.google.step_count.delta'
                        }],
                        bucketByTime: { durationMillis: 86400000 },
                        startTimeMillis: startOfDay.getTime(),
                        endTimeMillis: endOfDay.getTime()
                    };

                    const response = await window.gapi.client.request({
                        path: 'https://www.googleapis.com/fitness/v1/users/me/dataset:aggregate',
                        method: 'POST',
                        body: request,
                        headers: {
                            'Authorization': `Bearer ${this.accessToken}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    let totalSteps = 0;
                    if (response.result.bucket && response.result.bucket.length > 0) {
                        response.result.bucket.forEach(bucket => {
                            if (bucket.dataset && bucket.dataset.length > 0) {
                                bucket.dataset.forEach(dataset => {
                                    if (dataset.point && dataset.point.length > 0) {
                                        dataset.point.forEach(point => {
                                            if (point.value && point.value.length > 0) {
                                                totalSteps += point.value[0].intVal || 0;
                                            }
                                        });
                                    }
                                });
                            }
                        });
                    }

                    return totalSteps;
                } catch (error) {
                    log('Google Fit sync error: ' + error.message);
                    return 0;
                }
            }
        };
        
        // Initialize
        async function init() {
            log('Initializing Step Scientists...');
            await testConnection();
            await googleFitService.initialize();
            loadGame();
            await loadSpecies();
            updateDisplay();
            
            // Auto-sync every 5 minutes
            setInterval(syncSteps, 300000);
        }
        
        // Test connection
        async function testConnection() {
            var statusEl = document.getElementById('connection-status');
            statusEl.textContent = 'Connecting...';
            statusEl.className = 'connection-status connecting';
            
            try {
                var response = await fetch(API_BASE + '/health');
                var data = await response.json();
                
                if (response.ok) {
                    statusEl.textContent = '‚úÖ Backend Connected';
                    statusEl.className = 'connection-status connected';
                    isConnected = true;
                    log('Connected to backend!');
                } else {
                    throw new Error('Server error');
                }
            } catch (error) {
                statusEl.textContent = '‚ùå Backend Offline';
                statusEl.className = 'connection-status disconnected';
                isConnected = false;
                log('Backend offline - limited functionality');
            }
        }
        
        // Update Google Fit status
        function updateGoogleFitStatus() {
            var statusEl = document.getElementById('google-fit-status');
            
            if (googleFitService.authorized) {
                statusEl.textContent = '‚úÖ Google Fit Connected';
                statusEl.className = 'google-fit-status connected';
            } else if (googleFitService.initialized) {
                statusEl.textContent = 'üè• Tap to connect Google Fit';
                statusEl.className = 'google-fit-status disconnected';
            } else {
                statusEl.textContent = 'üè• Google Fit Loading...';
                statusEl.className = 'google-fit-status connecting';
            }
        }
        
        // Connect Google Fit
        async function connectGoogleFit() {
            if (googleFitService.authorized) {
                await syncSteps();
                return;
            }
            
            log('Connecting to Google Fit...');
            await googleFitService.authorize();
            await syncSteps();
        }
        
        // Sync steps from Google Fit
        async function syncSteps() {
            if (!googleFitService.authorized) {
                log('Google Fit not connected');
                return;
            }
            
            try {
                log('Syncing steps from Google Fit...');
                const realSteps = await googleFitService.getStepsToday();
                
                if (realSteps > game.steps) {
                    const newSteps = realSteps - game.steps;
                    game.steps = realSteps;
                    
                    // Calculate rewards for new steps
                    calculateStepRewards(newSteps);
                    
                    log('‚úÖ Synced ' + newSteps + ' new steps! Total: ' + realSteps);
                    saveGame();
                    updateDisplay();
                } else if (realSteps > 0) {
                    log('üìä Steps up to date: ' + realSteps);
                } else {
                    log('No step data found');
                }
            } catch (error) {
                log('Step sync failed: ' + error.message);
            }
        }
        
        // Calculate rewards for new steps
        function calculateStepRewards(newSteps) {
            var oldSteps = game.steps - newSteps;
            
            if (game.mode === 'discovery') {
                var oldCells = Math.floor(oldSteps / 1000);
                var newCells = Math.floor(game.steps / 1000);
                var cellsEarned = newCells - oldCells;
                
                if (cellsEarned > 0) {
                    game.cells += cellsEarned;
                    log('üéâ Earned ' + cellsEarned + ' cells from walking!');
                }
            } else {
                var oldExp = Math.floor(oldSteps / 10);
                var newExp = Math.floor(game.steps / 10);
                var expEarned = newExp - oldExp;
                
                if (expEarned > 0) {
                    game.experience += expEarned;
                    log('üí™ Earned ' + expEarned + ' experience from walking!');
                }
            }
            
            checkMilestones();
        }
        
        // Add steps (manual for testing)
        function addSteps() {
            var oldSteps = game.steps;
            game.steps += 100;
            calculateStepRewards(100);
            updateDisplay();
            saveGame();
        }
        
        // Switch mode
        function switchMode() {
            game.mode = game.mode === 'discovery' ? 'training' : 'discovery';
            updateDisplay();
            log('Switched to ' + game.mode + ' mode');
            saveGame();
        }
        
        // Toggle magnifying glass
        function toggleMagnifyingGlass() {
            if (game.magnifyingGlass < 1) {
                log('No magnifying glasses available!');
                return;
            }
            
            useMagnifyingGlass = !useMagnifyingGlass;
            var glassBtn = document.getElementById('glass-btn');
            
            if (useMagnifyingGlass) {
                glassBtn.innerHTML = 'üîç Glass ON';
                glassBtn.className = 'btn btn-warning';
                log('Magnifying glass ready! Will be used on next discovery.');
            } else {
                glassBtn.innerHTML = 'Use üîç Glass (' + game.magnifyingGlass + ')';
                glassBtn.className = 'btn';
                log('Magnifying glass deactivated.');
            }
            updateDisplay();
        }
        
        // Inspect cell
        async function inspectCell() {
            if (game.cells < 1) {
                log('Need at least 1 cell!');
                return;
            }
            
            if (!isConnected) {
                log('Need backend connection!');
                return;
            }
            
            game.cells--;
            
            var magnifyingGlassData = null;
            if (useMagnifyingGlass && game.magnifyingGlass > 0) {
                magnifyingGlassData = { tier: 'common' };
                game.magnifyingGlass--;
                useMagnifyingGlass = false;
                var glassBtn = document.getElementById('glass-btn');
                glassBtn.innerHTML = 'Use üîç Glass';
                glassBtn.className = 'btn';
                log('Used magnifying glass!');
            }
            
            updateDisplay();
            
            try {
                var response = await fetch(API_BASE + '/api/species/discover', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        playerId: 'mobile_player',
                        magnifyingGlass: magnifyingGlassData
                    })
                });
                
                if (response.ok) {
                    var result = await response.json();
                    
                    if (result.success) {
                        var species = result.species;
                        
                        if (result.isNewDiscovery) {
                            game.discoveredSpecies.push(species.id);
                            log('üéâ NEW! ' + species.rarity.toUpperCase() + ' ' + species.name + ' ' + species.emoji);
                        } else {
                            log('Found ' + species.name + ' ' + species.emoji + ' (known)');
                        }
                        
                        updateSpeciesGrid();
                        saveGame();
                    } else {
                        log('Discovery failed: ' + result.error);
                    }
                } else {
                    throw new Error('Request failed');
                }
            } catch (error) {
                log('Discovery error: ' + error.message);
                game.cells++; // Refund
                if (magnifyingGlassData) game.magnifyingGlass++; // Refund glass
                updateDisplay();
            }
        }
        
        // View steplings
        function viewSteplings() {
            var speciesSection = document.getElementById('species-section');
            var steplingsSection = document.getElementById('steplings-section');
            
            if (speciesSection) speciesSection.style.display = 'none';
            if (steplingsSection) steplingsSection.style.display = 'block';
            
            log('Viewing steplings...');
            loadSteplings();
        }
        
        // Hide steplings
        function hideSteplings() {
            document.getElementById('steplings-section').style.display = 'none';
            document.getElementById('species-section').style.display = 'block';
        }
        
        // Load species
        async function loadSpecies() {
            if (!isConnected) return;
            
            try {
                var response = await fetch(API_BASE + '/api/species/all');
                if (response.ok) {
                    allSpecies = await response.json();
                    log('Loaded ' + allSpecies.length + ' species');
                    updateSpeciesGrid();
                }
            } catch (error) {
                log('Species load error: ' + error.message);
            }
        }
        
        // Load steplings
        async function loadSteplings() {
            if (!isConnected) return;
            
            try {
                var response = await fetch(API_BASE + '/api/steplings');
                if (response.ok) {
                    var result = await response.json();
                    playerSteplings = result.data || [];
                    log('Loaded ' + playerSteplings.length + ' steplings');
                    updateSteplingsGrid();
                }
            } catch (error) {
                log('Steplings load error: ' + error.message);
            }
        }
        
        // Check milestones
        function checkMilestones() {
            var milestones = [5000, 10000, 50000, 100000];
            
            for (var i = 0; i < milestones.length; i++) {
                var milestone = milestones[i];
                if (game.steps >= milestone && game.milestonesReached.indexOf(milestone) === -1) {
                    game.magnifyingGlass++;
                    game.milestonesReached.push(milestone);
                    log('üéâ ' + milestone + ' steps! Earned magnifying glass! Total: ' + game.magnifyingGlass);
                }
            }
        }
        
        // Update display
        function updateDisplay() {
            document.getElementById('step-count').innerHTML = game.steps.toLocaleString();
            document.getElementById('cells').innerHTML = game.cells;
            document.getElementById('exp').innerHTML = game.experience;
            document.getElementById('glass').innerHTML = game.magnifyingGlass;
            
            if (game.mode === 'discovery') {
                document.getElementById('mode-title').innerHTML = 'üîç Discovery Mode';
                document.getElementById('mode-desc').innerHTML = '1000 steps = 1 cell';
            } else {
                document.getElementById('mode-title').innerHTML = 'üí™ Training Mode';
                document.getElementById('mode-desc').innerHTML = '10 steps = 1 experience';
            }
            
            var inspectBtn = document.getElementById('inspect-btn');
            if (game.cells >= 1 && isConnected) {
                inspectBtn.innerHTML = 'Inspect Cell (' + game.cells + ')';
                inspectBtn.disabled = false;
            } else {
                inspectBtn.innerHTML = game.cells < 1 ? 'Need 1 Cell' : 'Need Backend';
                inspectBtn.disabled = true;
            }
            
            var glassBtn = document.getElementById('glass-btn');
            if (game.magnifyingGlass < 1) {
                glassBtn.disabled = true;
                glassBtn.innerHTML = 'No Glass';
            } else {
                glassBtn.disabled = false;
                if (useMagnifyingGlass) {
                    glassBtn.innerHTML = 'üîç Glass ON';
                    glassBtn.className = 'btn btn-warning';
                } else {
                    glassBtn.innerHTML = 'Use üîç Glass (' + game.magnifyingGlass + ')';
                    glassBtn.className = 'btn';
                }
            }
        }
        
        // Update species grid
        function updateSpeciesGrid() {
            var grid = document.getElementById('species-grid');
            var html = '';
            
            for (var i = 0; i < allSpecies.length; i++) {
                var s = allSpecies[i];
                var discovered = s.discovered || game.discoveredSpecies.indexOf(s.id) !== -1;
                html += '<div class="card">';
                html += '<div class="emoji">' + (discovered ? s.emoji : '‚ùì') + '</div>';
                html += '<div class="name">' + (discovered ? s.name : '???') + '</div>';
                if (discovered) html += '<div style="font-size: 10px; opacity: 0.7;">' + s.rarity + '</div>';
                html += '</div>';
            }
            
            grid.innerHTML = html || '<div class="card">Loading species...</div>';
        }
        
        // Update steplings grid
        function updateSteplings() {
            var grid = document.getElementById('steplings-grid');
            var html = '';
            
            if (playerSteplings.length === 0) {
                html = '<div class="card">No steplings yet!</div>';
            } else {
                for (var i = 0; i < playerSteplings.length; i++) {
                    var s = playerSteplings[i];
                    var species = s.species || { name: 'Unknown', emoji: '‚ùì' };
                    html += '<div class="card" onclick="selectStepling(\'' + s.id + '\')">';
                    html += '<div class="emoji">' + species.emoji + '</div>';
                    html += '<div class="name">' + species.name + '</div>';
                    html += '<div style="font-size: 10px;">Lv.' + s.level + ' F.' + s.fusionLevel + '</div>';
                    html += '</div>';
                }
            }
            
            grid.innerHTML = html;
        }
        
        // Select stepling
        function selectStepling(steplingId) {
            var stepling = playerSteplings.find(s => s.id === steplingId);
            if (stepling) {
                var species = stepling.species || { name: 'Unknown' };
                log('Selected ' + species.name + ' (Lv.' + stepling.level + ' F.' + stepling.fusionLevel + ')');
            }
        }
        
        // Save/load
        function saveGame() {
            if (typeof localStorage !== 'undefined') {
                localStorage.setItem('stepScientistsComplete', JSON.stringify(game));
            }
        }
        
        function loadGame() {
            if (typeof localStorage !== 'undefined') {
                var saved = localStorage.getItem('stepScientistsComplete');
                if (saved) {
                    var loadedGame = JSON.parse(saved);
                    game = Object.assign({
                        steps: 0,
                        mode: 'discovery',
                        cells: 0,
                        experience: 0,
                        magnifyingGlass: 0,
                        discoveredSpecies: [],
                        milestonesReached: []
                    }, loadedGame);
                    
                    if (!Array.isArray(game.milestonesReached)) {
                        game.milestonesReached = [];
                    }
                    
                    log('Game loaded!');
                }
            }
        }
        
        // Log
        function log(message) {
            var logEl = document.getElementById('log');
            var time = new Date().toLocaleTimeString();
            logEl.innerHTML = '[' + time + '] ' + message;
            console.log('[Step Scientists] ' + message);
        }
        
        // Start
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>