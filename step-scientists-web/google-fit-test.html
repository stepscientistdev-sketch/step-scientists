<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Step Scientists - Google Fit Web Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        .status {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        .steps {
            font-size: 3em;
            font-weight: bold;
            text-align: center;
            margin: 30px 0;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        button {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            border: none;
            color: white;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 25px;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .config {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 0.9em;
        }
        .error {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid rgba(255, 0, 0, 0.5);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .success {
            background: rgba(0, 255, 0, 0.2);
            border: 1px solid rgba(0, 255, 0, 0.5);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üö∂‚Äç‚ôÇÔ∏è Step Scientists</h1>
        <h2 style="text-align: center; margin-bottom: 30px;">Google Fit Web Test</h2>
        
        <div class="status" id="status">
            Ready to test Google Fit integration
        </div>

        <div id="authSection">
            <button onclick="signIn()" id="signInBtn">
                üîê Connect Google Fit
            </button>
        </div>

        <div id="dataSection" style="display: none;">
            <div class="steps" id="stepCount">
                0 steps
            </div>
            
            <button onclick="getSteps()" id="refreshBtn">
                üîÑ Refresh Steps
            </button>
            
            <button onclick="signOut()" id="signOutBtn">
                üö™ Disconnect
            </button>
        </div>

        <div class="config">
            <strong>Configuration:</strong><br>
            Web Client ID: 570511343860-48hgn66bnn5vjdsvb3m62m4qpinbfl9n.apps.googleusercontent.com<br>
            Scopes: fitness.activity.read<br>
            Status: Ready to test Google Fit Web API
        </div>

        <div id="errorDiv" style="display: none;"></div>
    </div>

    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <script>
        const CLIENT_ID = '570511343860-48hgn66bnn5vjdsvb3m62m4qpinbfl9n.apps.googleusercontent.com';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/fitness/v1/rest';
        const SCOPES = 'https://www.googleapis.com/auth/fitness.activity.read';

        let gapi;
        let tokenClient;
        let accessToken = null;

        // Initialize Google APIs
        function initializeGapi() {
            updateStatus('Initializing Google APIs...');
            
            gapi.load('client', async () => {
                try {
                    await gapi.client.init({
                        discoveryDocs: [DISCOVERY_DOC],
                    });
                    
                    tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: CLIENT_ID,
                        scope: SCOPES,
                        callback: (tokenResponse) => {
                            accessToken = tokenResponse.access_token;
                            updateStatus('‚úÖ Connected to Google Fit!');
                            showDataSection();
                            getSteps();
                        },
                    });
                    
                    updateStatus('Ready to connect to Google Fit');
                } catch (error) {
                    showError('Failed to initialize Google APIs: ' + error.message);
                }
            });
        }

        function signIn() {
            updateStatus('Requesting Google Fit access...');
            if (tokenClient) {
                tokenClient.requestAccessToken();
            } else {
                showError('Google APIs not initialized');
            }
        }

        function signOut() {
            if (accessToken) {
                google.accounts.oauth2.revoke(accessToken);
                accessToken = null;
            }
            showAuthSection();
            updateStatus('Disconnected from Google Fit');
        }

        async function getSteps() {
            if (!accessToken) {
                showError('Not connected to Google Fit');
                return;
            }

            try {
                updateStatus('Getting step data...');
                
                const today = new Date();
                const startOfDay = new Date(today);
                startOfDay.setHours(0, 0, 0, 0);
                
                const endOfDay = new Date(today);
                endOfDay.setHours(23, 59, 59, 999);

                const request = {
                    aggregateBy: [{
                        dataTypeName: 'com.google.step_count.delta',
                        dataSourceId: 'derived:com.google.step_count.delta:com.google.android.gms:estimated_steps'
                    }],
                    bucketByTime: { durationMillis: 86400000 }, // 1 day
                    startTimeMillis: startOfDay.getTime(),
                    endTimeMillis: endOfDay.getTime()
                };

                const response = await gapi.client.request({
                    path: 'https://www.googleapis.com/fitness/v1/users/me/dataset:aggregate',
                    method: 'POST',
                    body: request,
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                let totalSteps = 0;
                if (response.result.bucket && response.result.bucket.length > 0) {
                    response.result.bucket.forEach(bucket => {
                        if (bucket.dataset && bucket.dataset.length > 0) {
                            bucket.dataset.forEach(dataset => {
                                if (dataset.point && dataset.point.length > 0) {
                                    dataset.point.forEach(point => {
                                        if (point.value && point.value.length > 0) {
                                            totalSteps += point.value[0].intVal || 0;
                                        }
                                    });
                                }
                            });
                        }
                    });
                }

                document.getElementById('stepCount').textContent = `${totalSteps.toLocaleString()} steps`;
                updateStatus(`‚úÖ Retrieved ${totalSteps} steps for today!`);
                
                if (totalSteps === 0) {
                    updateStatus('No step data found. Try walking around and refresh!');
                }

            } catch (error) {
                console.error('Error getting steps:', error);
                showError('Failed to get step data: ' + error.message);
            }
        }

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorDiv');
            errorDiv.innerHTML = `<div class="error">‚ùå ${message}</div>`;
            errorDiv.style.display = 'block';
        }

        function showSuccess(message) {
            const errorDiv = document.getElementById('errorDiv');
            errorDiv.innerHTML = `<div class="success">‚úÖ ${message}</div>`;
            errorDiv.style.display = 'block';
        }

        function showAuthSection() {
            document.getElementById('authSection').style.display = 'block';
            document.getElementById('dataSection').style.display = 'none';
        }

        function showDataSection() {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('dataSection').style.display = 'block';
        }

        // Initialize when page loads
        window.onload = function() {
            // Load Google APIs
            if (typeof gapi === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://apis.google.com/js/api.js';
                script.onload = initializeGapi;
                document.head.appendChild(script);
            } else {
                initializeGapi();
            }
        };
    </script>
</body>
</html>