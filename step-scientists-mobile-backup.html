<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Step Scientists - Mobile</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Color Emoji', 'Apple Color Emoji', 'Segoe UI Emoji', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            margin: 0;
            padding: 20px;
        }
        
        .app { max-width: 400px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        
        .connection-status {
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .connected { background: rgba(76, 175, 80, 0.3); }
        .disconnected { background: rgba(244, 67, 54, 0.3); }
        .connecting { background: rgba(255, 152, 0, 0.3); }
        
        .step-display {
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .step-count { font-size: 48px; font-weight: bold; margin-bottom: 10px; }
        
        .mode-display {
            background: rgba(255,255,255,0.15);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .resources {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .resource {
            background: rgba(255,255,255,0.15);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .resource-value { font-size: 24px; font-weight: bold; }
        .resource-label { font-size: 12px; opacity: 0.8; }
        
        .buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .btn:active {
            background: rgba(255,255,255,0.4);
            transform: scale(0.95);
        }
        
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: rgba(76, 175, 80, 0.8); }
        .btn-secondary { background: rgba(33, 150, 243, 0.8); }
        .btn-warning { background: rgba(255, 193, 7, 0.8); }
        
        .section {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .card {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
        }
        
        .card:active { background: rgba(255,255,255,0.2); }
        
        .card.selected {
            background: rgba(76, 175, 80, 0.4);
            border: 2px solid rgba(76, 175, 80, 0.8);
        }
        
        .card.max-level {
            opacity: 0.6;
            border: 1px solid rgba(255, 193, 7, 0.5);
        }
        
        .card.suboptimal {
            border-left: 4px solid rgba(255, 87, 34, 0.8);
        }
        
        .suboptimal-indicator {
            font-size: 10px;
            color: #ff5722;
            font-weight: bold;
        }
        
        .fusion-slot {
            width: 80px;
            height: 80px;
            border: 2px dashed rgba(255,255,255,0.3);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background: rgba(255,255,255,0.1);
        }
        
        .fusion-slot.filled {
            border: 2px solid rgba(76, 175, 80, 0.8);
            background: rgba(76, 175, 80, 0.2);
        }
        
        .fusion-slot.active {
            border: 2px solid rgba(33, 150, 243, 0.8);
            background: rgba(33, 150, 243, 0.2);
        }
        
        .fusion-result-slot {
            border-color: rgba(255, 193, 7, 0.8);
            background: rgba(255, 193, 7, 0.1);
            cursor: default;
        }
        
        .fusion-placeholder {
            font-size: 10px;
            text-align: center;
            opacity: 0.7;
        }
        
        .fusion-stepling {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .fusion-stepling .emoji {
            font-size: 20px;
            margin-bottom: 2px;
        }
        
        .fusion-stepling .name {
            font-size: 8px;
        }
        
        .emoji { font-size: 24px; margin-bottom: 5px; }
        .name { font-size: 12px; }
        
        .log {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
            font-family: monospace;
            max-height: 100px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="header">
            <h1>üß™ Step Scientists</h1>
            <div id="connection-status" class="connection-status connecting">Connecting...</div>
        </div>
        
        <div class="step-display">
            <div id="step-count" class="step-count">0</div>
            <div>Steps Today</div>
        </div>
        
        <div class="mode-display">
            <div id="mode-title">üîç Discovery Mode</div>
            <div id="mode-desc">1000 steps = 1 cell</div>
        </div>
        
        <div class="resources">
            <div class="resource">
                <div id="cells" class="resource-value">0</div>
                <div class="resource-label">Cells</div>
            </div>
            <div class="resource">
                <div id="exp" class="resource-value">0</div>
                <div class="resource-label">Experience</div>
            </div>
            <div class="resource">
                <div id="exp-bank" class="resource-value">0</div>
                <div class="resource-label">XP Bank</div>
            </div>
            <div class="resource">
                <div id="glass" class="resource-value">0</div>
                <div class="resource-label">üîç Glass</div>
                <button onclick="showGlassInventory()" style="font-size: 10px; padding: 2px 6px; margin-top: 2px; background: rgba(255,255,255,0.2); border: none; border-radius: 3px; color: white;">View</button>
            </div>
        </div>
        
        <!-- Milestone Progress Display -->
        <div id="milestone-progress" class="section" style="background: rgba(255,255,255,0.15); border-radius: 15px; padding: 15px; margin-bottom: 20px;">
            <h3 style="margin-bottom: 15px; text-align: center; font-size: 16px;">üîç Magnifying Glass Progress</h3>
            <div id="milestone-bars">
                <!-- Progress bars will be populated here -->
            </div>
        </div>
        
        <div class="buttons">
            <button class="btn btn-primary" onclick="addSteps()">+100 Steps</button>
            <button class="btn btn-secondary" onclick="switchMode()">Switch Mode</button>
            <button class="btn" onclick="inspectCell()" id="inspect-btn">Inspect Cell</button>
            <button class="btn" onclick="toggleMagnifyingGlass()" id="glass-btn">Use üîç Glass</button>
            <button class="btn" onclick="viewSteplings()">View Steplings</button>
            <button class="btn btn-warning" onclick="manageTrainingRoster()" id="training-btn">Training Roster</button>
            <button class="btn btn-secondary" onclick="manageFusion()" id="fusion-btn">Fusion Lab</button>
        </div>
        
        <div id="species-section" class="section">
            <h3>Species Collection</h3>
            <div id="species-grid" class="grid">
                <div class="card">Loading...</div>
            </div>
        </div>
        
        <div id="steplings-section" class="section" style="display: none;">
            <h3>My Steplings</h3>
            <div id="steplings-grid" class="grid">
                <div class="card">Loading...</div>
            </div>
            <div style="text-align: center; margin-top: 15px;">
                <button class="btn" onclick="hideSteplings()">Back</button>
                <button class="btn btn-secondary" onclick="loadSteplings()">Refresh</button>
            </div>
        </div>
        
        <div id="training-roster-section" class="section" style="display: none;">
            <h3>Training Roster</h3>
            <p style="font-size: 14px; opacity: 0.8; margin-bottom: 15px;">
                Select steplings to receive experience points in Training Mode (Max 10, ordered 1-10)
            </p>
            <div id="training-roster-grid" class="grid">
                <div class="card">Loading...</div>
            </div>
            <div style="text-align: center; margin-top: 15px;">
                <button class="btn" onclick="hideTrainingRoster()">Back</button>
                <button class="btn btn-primary" onclick="saveTrainingRoster()">Save Roster</button>
                <button class="btn btn-warning" onclick="applyBankedExperience()" id="apply-exp-btn" style="display: none;">Apply Banked XP</button>
            </div>
        </div>
        
        <div id="fusion-section" class="section" style="display: none;">
            <h3>üî¨ Fusion Lab</h3>
            <p style="font-size: 14px; opacity: 0.8; margin-bottom: 15px;">
                Select 2 steplings of the same species and fusion level to create a stronger stepling
            </p>
            <div id="fusion-selection" style="margin-bottom: 15px;">
                <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 10px;">
                    <div id="fusion-slot-1" class="fusion-slot" onclick="selectFusionSlot(1)">
                        <div class="fusion-placeholder">Select Stepling 1</div>
                    </div>
                    <div style="font-size: 24px; align-self: center;">+</div>
                    <div id="fusion-slot-2" class="fusion-slot" onclick="selectFusionSlot(2)">
                        <div class="fusion-placeholder">Select Stepling 2</div>
                    </div>
                    <div style="font-size: 24px; align-self: center;">=</div>
                    <div id="fusion-result" class="fusion-slot fusion-result-slot">
                        <div class="fusion-placeholder">Result</div>
                    </div>
                </div>
                <div style="text-align: center;">
                    <button class="btn btn-primary" onclick="performFusion()" id="fusion-execute-btn" disabled>Fuse Steplings</button>
                </div>
            </div>
            <div id="fusion-steplings-grid" class="grid">
                <div class="card">Loading...</div>
            </div>
            <div style="text-align: center; margin-top: 15px;">
                <button class="btn" onclick="hideFusion()">Back</button>
                <button class="btn btn-secondary" onclick="loadFusionSteplings()">Refresh</button>
            </div>
        </div>
        
        <div id="stepling-details-section" class="section" style="display: none;">
            <h3 id="stepling-details-title">Stepling Details</h3>
            <div id="stepling-details-content" style="text-align: center;">
                <div id="stepling-details-main" style="margin-bottom: 20px;">
                    <div id="stepling-emoji" style="font-size: 48px; margin-bottom: 10px;">ü¶ó</div>
                    <div id="stepling-name" style="font-size: 20px; font-weight: bold; margin-bottom: 5px;">Grasshopper</div>
                    <div id="stepling-level-info" style="font-size: 14px; opacity: 0.8; margin-bottom: 15px;">Level 1/10 ‚Ä¢ Fusion 1</div>
                </div>
                
                <div id="stepling-stats" style="background: rgba(255,255,255,0.1); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 10px;">Stats</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px;">
                            <div style="font-size: 12px; opacity: 0.7;">Health</div>
                            <div id="stat-health" style="font-size: 18px; font-weight: bold;">100</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px;">
                            <div style="font-size: 12px; opacity: 0.7;">Attack</div>
                            <div id="stat-attack" style="font-size: 18px; font-weight: bold;">50</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px;">
                            <div style="font-size: 12px; opacity: 0.7;">Defense</div>
                            <div id="stat-defense" style="font-size: 18px; font-weight: bold;">40</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px;">
                            <div style="font-size: 12px; opacity: 0.7;">Special</div>
                            <div id="stat-special" style="font-size: 18px; font-weight: bold;">30</div>
                        </div>
                    </div>
                </div>
                
                <div id="stepling-info" style="background: rgba(255,255,255,0.1); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 10px;">Info</h4>
                    <div style="text-align: left; font-size: 14px;">
                        <div style="margin-bottom: 5px;"><strong>Species:</strong> <span id="info-species">Grasshopper</span></div>
                        <div style="margin-bottom: 5px;"><strong>Rarity:</strong> <span id="info-rarity">Common</span></div>
                        <div style="margin-bottom: 5px;"><strong>Max Level:</strong> <span id="info-max-level">10</span></div>
                        <div style="margin-bottom: 5px;"><strong>Next Level:</strong> <span id="info-next-level">10 EXP needed</span></div>
                        <div style="margin-bottom: 5px;"><strong>Created:</strong> <span id="info-created">Just now</span></div>
                        <div><strong>Release Value:</strong> <span id="info-release-value">0 EXP</span></div>
                    </div>
                </div>
                
                <div style="background: rgba(255,255,255,0.1); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 10px;">Actions</h4>
                    <button class="btn btn-danger" onclick="confirmReleaseStepling()" id="release-btn" style="width: 100%; background: #dc3545;">
                        üïäÔ∏è Release Stepling
                    </button>
                    <div style="font-size: 12px; opacity: 0.8; margin-top: 8px; text-align: center;">
                        Permanently release this stepling for experience points
                    </div>
                </div>
            </div>
            <div style="text-align: center;">
                <button class="btn" onclick="hideSteplingDetails()">Back</button>
            </div>
        </div>
        
        <!-- Magnifying Glass Inventory -->
        <div id="glass-inventory-section" class="section" style="display: none;">
            <h3>üîç Magnifying Glass Inventory</h3>
            <p style="font-size: 14px; opacity: 0.8; margin-bottom: 15px;">
                Select which magnifying glass to use for your next discovery
            </p>
            <div id="glass-inventory-grid" class="grid">
                <!-- Glass inventory will be populated here -->
            </div>
            <div style="text-align: center; margin-top: 15px;">
                <button class="btn" onclick="hideGlassInventory()">Back</button>
            </div>
        </div>
        
        <div id="log" class="log">Step Scientists loading...</div>
    </div>

    <script>
        const API_BASE = 'http://192.168.1.111:3000';
        
        var game = {
            steps: 5000,
            mode: 'discovery',
            cells: 5,
            experience: 0,
            experienceBank: 0, // Banked experience for future use
            magnifyingGlass: { uncommon: 0, rare: 0, epic: 0, legendary: 0 }, // Track different tiers
            discoveredSpecies: [],
            milestonesReached: [], // Track which milestones we've already awarded - now stores objects with {milestone, tier, cycle}
            trainingRoster: [], // Array of stepling IDs in training roster (ordered 1-10)
            rosterOrder: {}, // Maps steplingId to order number (1-10)
            fusionSlot1: null, // Selected stepling for fusion slot 1
            fusionSlot2: null, // Selected stepling for fusion slot 2
            activeFusionSlot: 1, // Which slot is currently being selected (1 or 2)
            selectedGlassTier: null // Which magnifying glass tier to use (null = auto-select best)
        };
        
        var allSpecies = [];
        var playerSteplings = [];
        var isConnected = false;
        var useMagnifyingGlass = false;
        
        // Initialize
        async function init() {
            log('Initializing Step Scientists...');
            await testConnection();
            loadGame();
            await loadSpecies();
            updateDisplay();
        }
        
        // Test connection
        async function testConnection() {
            var statusEl = document.getElementById('connection-status');
            statusEl.textContent = 'Connecting...';
            statusEl.className = 'connection-status connecting';
            
            try {
                var response = await fetch(API_BASE + '/health');
                var data = await response.json();
                
                if (response.ok) {
                    statusEl.textContent = '‚úÖ Connected';
                    statusEl.className = 'connection-status connected';
                    isConnected = true;
                    log('Connected to backend!');
                } else {
                    throw new Error('Server error');
                }
            } catch (error) {
                statusEl.textContent = '‚ùå Offline';
                statusEl.className = 'connection-status disconnected';
                isConnected = false;
                log('Offline mode');
            }
        }
        
        // Add steps
        async function addSteps() {
            var oldSteps = game.steps;
            game.steps += 100;
            
            if (game.mode === 'discovery') {
                var oldCells = Math.floor(oldSteps / 1000);
                var newCells = Math.floor(game.steps / 1000);
                var cellsToAdd = newCells - oldCells;
                
                if (cellsToAdd > 0) {
                    game.cells += cellsToAdd;
                    log('Earned ' + cellsToAdd + ' cells!');
                } else {
                    var needed = 1000 - (game.steps % 1000);
                    log(needed + ' more steps for next cell');
                }
            } else {
                var oldExp = Math.floor(oldSteps / 10);
                var newExp = Math.floor(game.steps / 10);
                var expToAdd = newExp - oldExp;
                
                if (expToAdd > 0) {
                    game.experience += expToAdd;
                    log('Earned ' + expToAdd + ' experience!');
                    
                    // Distribute experience to training roster
                    await distributeExperienceToRoster(expToAdd);
                }
            }
            
            checkMilestones();
            updateDisplay();
            saveGame();
        }
        
        // Switch mode
        function switchMode() {
            console.log('switchMode called, current mode:', game.mode);
            game.mode = game.mode === 'discovery' ? 'training' : 'discovery';
            console.log('new mode:', game.mode);
            updateDisplay();
            log('Switched to ' + game.mode + ' mode');
            saveGame();
        }
        
        // Toggle magnifying glass
        function toggleMagnifyingGlass() {
            var totalGlasses = getTotalGlasses();
            console.log('toggleMagnifyingGlass called, total glasses:', totalGlasses);
            if (totalGlasses < 1) {
                log('No magnifying glasses available!');
                return;
            }
            
            useMagnifyingGlass = !useMagnifyingGlass;
            var glassBtn = document.getElementById('glass-btn');
            console.log('useMagnifyingGlass is now:', useMagnifyingGlass);
            
            if (useMagnifyingGlass) {
                var selectedTier = game.selectedGlassTier || getBestGlassTier();
                if (selectedTier && game.magnifyingGlass[selectedTier] > 0) {
                    glassBtn.innerHTML = 'üîç Glass ON (' + selectedTier.toUpperCase() + ')';
                    glassBtn.className = 'btn btn-warning';
                    log('Magnifying glass ready! Will use ' + selectedTier + ' glass on next discovery.');
                } else {
                    // Selected tier not available, fall back to best available
                    var bestTier = getBestGlassTier();
                    if (bestTier) {
                        game.selectedGlassTier = bestTier;
                        glassBtn.innerHTML = 'üîç Glass ON (' + bestTier.toUpperCase() + ')';
                        glassBtn.className = 'btn btn-warning';
                        log('Selected tier unavailable, using ' + bestTier + ' glass instead.');
                    } else {
                        useMagnifyingGlass = false;
                        log('No magnifying glasses available!');
                    }
                }
            } else {
                glassBtn.innerHTML = 'Use üîç Glass (' + totalGlasses + ')';
                glassBtn.className = 'btn';
                log('Magnifying glass deactivated.');
            }
            updateDisplay();
        }
        
        // Inspect cell
        async function inspectCell() {
            if (game.cells < 1) {
                log('Need at least 1 cell!');
                return;
            }
            
            if (!isConnected) {
                log('Need backend connection!');
                return;
            }
            
            game.cells--;
            
            var magnifyingGlassData = null;
            if (useMagnifyingGlass && getTotalGlasses() > 0) {
                var selectedTier = game.selectedGlassTier || getBestGlassTier();
                
                if (selectedTier && game.magnifyingGlass[selectedTier] > 0) {
                    magnifyingGlassData = { tier: selectedTier };
                    
                    // Consume the glass
                    game.magnifyingGlass[selectedTier]--;
                    useMagnifyingGlass = false;
                    var glassBtn = document.getElementById('glass-btn');
                    glassBtn.innerHTML = 'Use üîç Glass';
                    glassBtn.className = 'btn';
                    log('Used ' + selectedTier + ' magnifying glass!');
                } else {
                    log('Selected magnifying glass not available!');
                    useMagnifyingGlass = false;
                }
            }
            
            updateDisplay();
            
            try {
                var response = await fetch(API_BASE + '/api/species/discover', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        playerId: '021cb11f-482a-44d2-b289-110400f23562', // Use correct UUID
                        magnifyingGlass: magnifyingGlassData
                    })
                });
                
                if (response.ok) {
                    var result = await response.json();
                    
                    if (result.success) {
                        var species = result.species;
                        
                        if (result.isNewDiscovery) {
                            game.discoveredSpecies.push(species.id);
                            log('üéâ NEW! ' + species.rarity.toUpperCase() + ' ' + species.name + ' ' + species.emoji);
                        } else {
                            log('Found ' + species.name + ' ' + species.emoji + ' (known)');
                        }
                        
                        updateSpeciesGrid();
                        saveGame();
                    } else {
                        log('Discovery failed: ' + result.error);
                    }
                } else {
                    throw new Error('Request failed');
                }
            } catch (error) {
                log('Discovery error: ' + error.message);
                game.cells++; // Refund
                if (magnifyingGlassData) {
                    // Refund the glass that was used
                    game.magnifyingGlass[magnifyingGlassData.tier]++;
                }
                updateDisplay();
            }
        }
        
        // Distribute experience to training roster with smart leveling and banking
        async function distributeExperienceToRoster(totalExp) {
            console.log('=== DISTRIBUTE EXPERIENCE DEBUG ===');
            console.log('totalExp:', totalExp);
            console.log('isConnected:', isConnected);
            console.log('game.trainingRoster:', game.trainingRoster);
            console.log('game.experienceBank:', game.experienceBank);
            
            if (!isConnected || game.trainingRoster.length === 0) {
                // Bank the experience if no roster is set
                game.experienceBank += totalExp;
                log('No training roster set. Banked ' + totalExp + ' experience.');
                updateDisplay();
                return;
            }
            
            // Add any banked experience to the total
            var availableExp = totalExp + game.experienceBank;
            var originalBanked = game.experienceBank;
            game.experienceBank = 0; // Clear the bank
            
            console.log('availableExp:', availableExp);
            console.log('originalBanked:', originalBanked);
            
            if (originalBanked > 0) {
                log('Using ' + originalBanked + ' banked + ' + totalExp + ' new = ' + availableExp + ' total experience');
            } else {
                log('Distributing ' + availableExp + ' experience to roster...');
            }
            
            // Get current stepling data to check levels
            await loadSteplings();
            console.log('playerSteplings after load:', playerSteplings.length);
            
            // Get steplings in roster order (1-10), filtering out max level ones
            var orderedSteplings = [];
            for (var i = 0; i < game.trainingRoster.length; i++) {
                var steplingId = game.trainingRoster[i];
                var stepling = playerSteplings.find(s => s.id === steplingId);
                console.log('Looking for stepling:', steplingId, 'found:', stepling ? stepling.species.name : 'NOT FOUND');
                
                if (stepling) {
                    var maxLevel = stepling.fusion_level * 10;
                    console.log('Stepling:', stepling.species.name, 'Level:', stepling.level, 'MaxLevel:', maxLevel);
                    
                    if (stepling.level < maxLevel) {
                        orderedSteplings.push({
                            stepling: stepling,
                            order: game.rosterOrder[steplingId] || (i + 1)
                        });
                        console.log('Added to ordered list at position:', game.rosterOrder[steplingId] || (i + 1));
                    } else {
                        console.log('Stepling is max level, skipping');
                    }
                }
            }
            
            console.log('orderedSteplings:', orderedSteplings.length);
            
            // Sort by roster order (1-10)
            orderedSteplings.sort((a, b) => a.order - b.order);
            
            if (orderedSteplings.length === 0) {
                // All steplings are max level, bank the experience
                game.experienceBank = availableExp;
                log('All roster steplings are max level. Banked ' + availableExp + ' experience.');
                updateDisplay();
                return;
            }
            
            // Distribute experience in order, maxing out each stepling before moving to next
            var remainingExp = availableExp;
            var leveledUp = [];
            
            for (var i = 0; i < orderedSteplings.length && remainingExp > 0; i++) {
                var steplingData = orderedSteplings[i];
                var stepling = steplingData.stepling;
                var maxLevel = stepling.fusion_level * 10;
                
                console.log('Processing stepling #' + steplingData.order + ':', stepling.species.name);
                console.log('Current level:', stepling.level, 'Max level:', maxLevel);
                console.log('Remaining exp:', remainingExp);
                
                // Calculate how much experience this stepling can use to max out
                var expNeeded = 0;
                var currentLevel = stepling.level;
                var tempExp = remainingExp;
                
                // Calculate total exp needed to max out this stepling
                while (currentLevel < maxLevel && tempExp > 0) {
                    var expForNextLevel = currentLevel * 10;
                    console.log('Level', currentLevel, 'needs', expForNextLevel, 'exp');
                    if (tempExp >= expForNextLevel) {
                        expNeeded += expForNextLevel;
                        tempExp -= expForNextLevel;
                        currentLevel++;
                        console.log('Can level up to', currentLevel, 'total exp needed so far:', expNeeded);
                    } else {
                        console.log('Not enough exp for next level');
                        break;
                    }
                }
                
                console.log('Final expNeeded for this stepling:', expNeeded);
                
                if (expNeeded > 0) {
                    // Level up this stepling
                    try {
                        console.log('Making API call to level up stepling:', stepling.id);
                        var response = await fetch(API_BASE + '/api/steplings/' + stepling.id + '/levelup', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ experiencePoints: expNeeded })
                        });
                        
                        console.log('API response status:', response.status);
                        
                        if (response.ok) {
                            var result = await response.json();
                            console.log('API result:', result);
                            
                            if (result.success) {
                                var updatedStepling = result.data;
                                var species = stepling.species || { name: 'Unknown' };
                                var levelsGained = updatedStepling.level - stepling.level;
                                log('‚ú® #' + steplingData.order + ' ' + species.name + ' gained ' + levelsGained + ' levels! (Lv.' + updatedStepling.level + ')');
                                leveledUp.push('#' + steplingData.order + ' ' + species.name);
                                remainingExp -= expNeeded;
                                console.log('Successfully leveled up, remaining exp:', remainingExp);
                            } else {
                                console.log('API returned success=false:', result.error);
                                log('Failed to level up ' + stepling.species.name + ': ' + (result.error || 'Unknown error'));
                            }
                        } else {
                            console.log('API response not ok:', response.status);
                            var errorText = await response.text();
                            console.log('Error response:', errorText);
                            log('API error leveling up ' + stepling.species.name);
                        }
                    } catch (error) {
                        console.error('Error leveling up stepling:', error);
                        log('Network error leveling up ' + stepling.species.name);
                    }
                }
            }
            
            // Bank any leftover experience
            if (remainingExp > 0) {
                game.experienceBank = remainingExp;
                log('Banked ' + remainingExp + ' leftover experience.');
            }
            
            // Show summary
            if (leveledUp.length > 0) {
                log('üéâ Leveled up: ' + leveledUp.join(', '));
            }
            
            // Refresh steplings to show updated levels
            await loadSteplings();
            updateDisplay();
            console.log('=== END DISTRIBUTE EXPERIENCE DEBUG ===');
        }
        
        // Manage training roster
        function manageTrainingRoster() {
            console.log('manageTrainingRoster called');
            document.getElementById('species-section').style.display = 'none';
            document.getElementById('steplings-section').style.display = 'none';
            document.getElementById('training-roster-section').style.display = 'block';
            
            log('Managing training roster...');
            loadTrainingRoster();
        }
        
        // Hide training roster
        function hideTrainingRoster() {
            document.getElementById('training-roster-section').style.display = 'none';
            document.getElementById('species-section').style.display = 'block';
        }
        
        // Load training roster
        async function loadTrainingRoster() {
            console.log('loadTrainingRoster called');
            if (!isConnected) {
                console.log('Not connected, skipping roster load');
                return;
            }
            
            // Make sure we have steplings loaded
            if (playerSteplings.length === 0) {
                console.log('Loading steplings first...');
                await loadSteplings();
            }
            
            console.log('Updating roster grid and apply button...');
            updateTrainingRosterGrid();
            updateApplyExpButton();
        }
        
        // Update the apply banked experience button visibility
        function updateApplyExpButton() {
            console.log('updateApplyExpButton called');
            console.log('experienceBank:', game.experienceBank);
            console.log('trainingRoster length:', game.trainingRoster.length);
            
            var applyBtn = document.getElementById('apply-exp-btn');
            if (!applyBtn) {
                console.error('apply-exp-btn element not found!');
                return;
            }
            
            if (game.experienceBank > 0 && game.trainingRoster.length > 0) {
                applyBtn.style.display = 'inline-block';
                applyBtn.innerHTML = 'Apply ' + game.experienceBank + ' Banked XP';
                console.log('Showing apply button');
            } else {
                applyBtn.style.display = 'none';
                console.log('Hiding apply button');
            }
        }
        
        // Manually apply banked experience
        async function applyBankedExperience() {
            console.log('applyBankedExperience called');
            if (game.experienceBank > 0 && game.trainingRoster.length > 0) {
                log('Manually applying ' + game.experienceBank + ' banked experience...');
                await distributeExperienceToRoster(0); // This will use the banked experience
                updateApplyExpButton();
                saveGame();
            } else {
                log('No banked experience or no training roster set.');
            }
        }
        
        // === FUSION SYSTEM ===
        
        // Manage fusion
        function manageFusion() {
            console.log('manageFusion called');
            document.getElementById('species-section').style.display = 'none';
            document.getElementById('steplings-section').style.display = 'none';
            document.getElementById('training-roster-section').style.display = 'none';
            document.getElementById('fusion-section').style.display = 'block';
            
            // Reset fusion state
            game.fusionSlot1 = null;
            game.fusionSlot2 = null;
            game.activeFusionSlot = 1;
            
            log('Opening Fusion Lab...');
            loadFusionSteplings();
        }
        
        // Hide fusion
        function hideFusion() {
            document.getElementById('fusion-section').style.display = 'none';
            document.getElementById('species-section').style.display = 'block';
        }
        
        // Load steplings for fusion
        async function loadFusionSteplings() {
            console.log('loadFusionSteplings called');
            if (!isConnected) {
                console.log('Not connected, skipping fusion load');
                return;
            }
            
            // Make sure we have steplings loaded
            if (playerSteplings.length === 0) {
                console.log('Loading steplings first...');
                await loadSteplings();
            }
            
            console.log('Updating fusion display...');
            updateFusionSlots();
            updateFusionSteplingsGrid();
        }
        
        // Select fusion slot
        function selectFusionSlot(slotNumber) {
            console.log('selectFusionSlot called:', slotNumber);
            game.activeFusionSlot = slotNumber;
            updateFusionSlots();
        }
        
        // Select stepling for fusion
        function selectSteplingForFusion(steplingId) {
            console.log('selectSteplingForFusion called:', steplingId, 'for slot', game.activeFusionSlot);
            
            var stepling = playerSteplings.find(s => s.id === steplingId);
            if (!stepling) {
                log('Stepling not found!');
                return;
            }
            
            // Check if stepling is already selected in other slot
            if (game.fusionSlot1 && game.fusionSlot1.id === steplingId) {
                log('Stepling already in slot 1');
                return;
            }
            if (game.fusionSlot2 && game.fusionSlot2.id === steplingId) {
                log('Stepling already in slot 2');
                return;
            }
            
            // Assign to active slot
            if (game.activeFusionSlot === 1) {
                game.fusionSlot1 = stepling;
                game.activeFusionSlot = 2; // Auto-switch to slot 2
                log('Selected ' + stepling.species.name + ' for slot 1');
            } else {
                game.fusionSlot2 = stepling;
                log('Selected ' + stepling.species.name + ' for slot 2');
            }
            
            updateFusionSlots();
            updateFusionSteplingsGrid();
        }
        
        // Update fusion slots display
        function updateFusionSlots() {
            console.log('updateFusionSlots called');
            
            // Update slot 1
            var slot1 = document.getElementById('fusion-slot-1');
            if (game.fusionSlot1) {
                slot1.className = 'fusion-slot filled';
                slot1.innerHTML = '<div class="fusion-stepling"><div class="emoji">' + game.fusionSlot1.species.emoji + '</div><div class="name">' + game.fusionSlot1.species.name + '</div><div style="font-size: 8px;">Lv.' + game.fusionSlot1.level + ' F.' + game.fusionSlot1.fusion_level + '</div></div>';
            } else {
                slot1.className = 'fusion-slot' + (game.activeFusionSlot === 1 ? ' active' : '');
                slot1.innerHTML = '<div class="fusion-placeholder">Select Stepling 1</div>';
            }
            
            // Update slot 2
            var slot2 = document.getElementById('fusion-slot-2');
            if (game.fusionSlot2) {
                slot2.className = 'fusion-slot filled';
                slot2.innerHTML = '<div class="fusion-stepling"><div class="emoji">' + game.fusionSlot2.species.emoji + '</div><div class="name">' + game.fusionSlot2.species.name + '</div><div style="font-size: 8px;">Lv.' + game.fusionSlot2.level + ' F.' + game.fusionSlot2.fusion_level + '</div></div>';
            } else {
                slot2.className = 'fusion-slot' + (game.activeFusionSlot === 2 ? ' active' : '');
                slot2.innerHTML = '<div class="fusion-placeholder">Select Stepling 2</div>';
            }
            
            // Update result slot and fusion button
            var resultSlot = document.getElementById('fusion-result');
            var fusionBtn = document.getElementById('fusion-execute-btn');
            
            if (game.fusionSlot1 && game.fusionSlot2) {
                // Check if fusion is valid
                var canFuse = game.fusionSlot1.species_id === game.fusionSlot2.species_id && 
                             game.fusionSlot1.fusion_level === game.fusionSlot2.fusion_level;
                
                if (canFuse) {
                    var newFusionLevel = game.fusionSlot1.fusion_level + 1;
                    var maxLevel1 = game.fusionSlot1.fusion_level * 10;
                    var maxLevel2 = game.fusionSlot2.fusion_level * 10;
                    var isSuboptimal = game.fusionSlot1.level < maxLevel1 || game.fusionSlot2.level < maxLevel2;
                    
                    resultSlot.innerHTML = '<div class="fusion-stepling"><div class="emoji">' + game.fusionSlot1.species.emoji + '</div><div class="name">' + game.fusionSlot1.species.name + '</div><div style="font-size: 8px;">Lv.1 F.' + newFusionLevel + '</div></div>';
                    fusionBtn.disabled = false;
                    
                    if (isSuboptimal) {
                        fusionBtn.innerHTML = '‚ö†Ô∏è Fuse (Suboptimal)';
                        fusionBtn.className = 'btn btn-warning';
                    } else {
                        fusionBtn.innerHTML = '‚ú® Fuse (Optimal)';
                        fusionBtn.className = 'btn btn-primary';
                    }
                } else {
                    resultSlot.innerHTML = '<div class="fusion-placeholder" style="color: #ff6b6b;">Invalid Fusion</div>';
                    fusionBtn.disabled = true;
                    fusionBtn.innerHTML = 'Cannot Fuse';
                    fusionBtn.className = 'btn';
                }
            } else {
                resultSlot.innerHTML = '<div class="fusion-placeholder">Result</div>';
                fusionBtn.disabled = true;
                fusionBtn.innerHTML = 'Select 2 Steplings';
                fusionBtn.className = 'btn';
            }
        }
        
        // Update fusion steplings grid
        function updateFusionSteplingsGrid() {
            console.log('updateFusionSteplingsGrid called');
            
            var grid = document.getElementById('fusion-steplings-grid');
            if (!grid) {
                console.error('fusion-steplings-grid element not found!');
                return;
            }
            
            var html = '';
            
            if (playerSteplings.length === 0) {
                html = '<div class="card">No steplings yet!</div>';
            } else {
                for (var i = 0; i < playerSteplings.length; i++) {
                    var s = playerSteplings[i];
                    var species = s.species || { name: 'Unknown', emoji: '‚ùì' };
                    var maxLevel = s.fusion_level * 10;
                    var isMaxLevel = s.level >= maxLevel;
                    var hasSuboptimalFusion = s.has_suboptimal_fusion || false;
                    var isSelected = (game.fusionSlot1 && game.fusionSlot1.id === s.id) || 
                                   (game.fusionSlot2 && game.fusionSlot2.id === s.id);
                    
                    var cardClass = 'card';
                    if (isSelected) cardClass += ' selected';
                    if (isMaxLevel) cardClass += ' max-level';
                    
                    html += '<div class="' + cardClass + '" onclick="selectSteplingForFusion(\'' + s.id + '\')">';
                    html += '<div class="emoji">' + species.emoji + '</div>';
                    html += '<div class="name">' + species.name + (hasSuboptimalFusion ? ' ‚ö†Ô∏è' : '') + '</div>';
                    html += '<div style="font-size: 10px;">Lv.' + s.level + '/' + maxLevel + ' F.' + s.fusion_level + '</div>';
                    if (isMaxLevel) {
                        html += '<div style="font-size: 9px; color: #ffc107;">MAX LEVEL</div>';
                    }
                    if (hasSuboptimalFusion) {
                        html += '<div style="font-size: 8px; color: #ff9800;">IMPERFECT</div>';
                    }
                    if (isSelected) {
                        html += '<div style="font-size: 12px; margin-top: 2px;">‚úì</div>';
                    }
                    html += '</div>';
                }
            }
            
            console.log('Setting fusion grid HTML');
            grid.innerHTML = html;
        }
        
        // Perform fusion
        async function performFusion() {
            console.log('performFusion called');
            
            if (!game.fusionSlot1 || !game.fusionSlot2) {
                log('Need to select 2 steplings for fusion');
                return;
            }
            
            if (!isConnected) {
                log('Need backend connection for fusion');
                return;
            }
            
            // Validate fusion
            if (game.fusionSlot1.species_id !== game.fusionSlot2.species_id) {
                log('Steplings must be the same species');
                return;
            }
            
            if (game.fusionSlot1.fusion_level !== game.fusionSlot2.fusion_level) {
                log('Steplings must be the same fusion level');
                return;
            }
            
            log('Performing fusion...');
            
            try {
                // Calculate new stepling stats using improved fusion formula
                var newFusionLevel = game.fusionSlot1.fusion_level + 1;
                
                // New formula: 10% of average current stats as bonus
                var avgStats = {
                    health: Math.round((game.fusionSlot1.current_stats.health + game.fusionSlot2.current_stats.health) / 2),
                    attack: Math.round((game.fusionSlot1.current_stats.attack + game.fusionSlot2.current_stats.attack) / 2),
                    defense: Math.round((game.fusionSlot1.current_stats.defense + game.fusionSlot2.current_stats.defense) / 2),
                    special: Math.round((game.fusionSlot1.current_stats.special + game.fusionSlot2.current_stats.special) / 2)
                };
                
                var fusionBonus = {
                    health: Math.round(avgStats.health * 0.1),
                    attack: Math.round(avgStats.attack * 0.1),
                    defense: Math.round(avgStats.defense * 0.1),
                    special: Math.round(avgStats.special * 0.1)
                };
                
                // Get base stats (Grasshopper base: 20/15/10/5)
                var baseStats = { health: 20, attack: 15, defense: 10, special: 5 }; // TODO: Get from species data
                
                // New base stats = original base + fusion bonus, with minimum of original base
                var newStats = {
                    health: Math.max(baseStats.health + fusionBonus.health, baseStats.health),
                    attack: Math.max(baseStats.attack + fusionBonus.attack, baseStats.attack),
                    defense: Math.max(baseStats.defense + fusionBonus.defense, baseStats.defense),
                    special: Math.max(baseStats.special + fusionBonus.special, baseStats.special)
                };
                
                var newStepling = {
                    player_id: '021cb11f-482a-44d2-b289-110400f23562',
                    species_id: game.fusionSlot1.species_id,
                    level: 1,
                    fusion_level: newFusionLevel,
                    current_stats: newStats
                };
                
                var response = await fetch(API_BASE + '/api/steplings/fuse', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        newStepling: newStepling,
                        removedSteplingIds: [game.fusionSlot1.id, game.fusionSlot2.id]
                    })
                });
                
                console.log('Fusion API response status:', response.status);
                
                if (response.ok) {
                    var result = await response.json();
                    console.log('Fusion API result:', result);
                    
                    if (result.success) {
                        log('üéâ Fusion successful! Created ' + game.fusionSlot1.species.name + ' F.' + newFusionLevel);
                        
                        // Reset fusion state
                        game.fusionSlot1 = null;
                        game.fusionSlot2 = null;
                        game.activeFusionSlot = 1;
                        
                        // Refresh steplings
                        await loadSteplings();
                        await loadFusionSteplings();
                    } else {
                        log('Fusion failed: ' + (result.error || 'Unknown error'));
                    }
                } else {
                    var errorText = await response.text();
                    console.log('Fusion API error:', errorText);
                    log('Fusion failed: Server error');
                }
            } catch (error) {
                console.error('Error performing fusion:', error);
                log('Fusion failed: Network error');
            }
        }
        
        // Save training roster and apply banked experience
        async function saveTrainingRoster() {
            log('Training roster saved! ' + game.trainingRoster.length + ' steplings selected.');
            
            // If there's banked experience and we have a roster, apply it immediately
            if (game.experienceBank > 0 && game.trainingRoster.length > 0) {
                log('Applying ' + game.experienceBank + ' banked experience to new roster...');
                await distributeExperienceToRoster(0); // This will use the banked experience
            }
            
            saveGame();
            hideTrainingRoster();
        }
        
        // Toggle stepling in training roster with ordering (1-10)
        function toggleSteplingInRoster(steplingId) {
            console.log('toggleSteplingInRoster called with:', steplingId);
            console.log('Current roster:', game.trainingRoster);
            console.log('Current order:', game.rosterOrder);
            
            var index = game.trainingRoster.indexOf(steplingId);
            if (index === -1) {
                // Add to roster
                if (game.trainingRoster.length >= 10) {
                    log('Training roster is full! (Max 10 steplings)');
                    return;
                }
                
                var orderNumber = game.trainingRoster.length + 1;
                game.trainingRoster.push(steplingId);
                game.rosterOrder[steplingId] = orderNumber;
                log('Added to training roster at position #' + orderNumber);
            } else {
                // Remove from roster and reorder
                game.trainingRoster.splice(index, 1);
                delete game.rosterOrder[steplingId];
                
                // Reorder remaining steplings
                game.rosterOrder = {}; // Clear and rebuild
                for (var i = 0; i < game.trainingRoster.length; i++) {
                    game.rosterOrder[game.trainingRoster[i]] = i + 1;
                }
                
                log('Removed from training roster');
            }
            
            console.log('Updated roster:', game.trainingRoster);
            console.log('Updated order:', game.rosterOrder);
            
            updateTrainingRosterGrid();
            updateApplyExpButton();
        }
        function viewSteplings() {
            console.log('viewSteplings called');
            var speciesSection = document.getElementById('species-section');
            var steplingsSection = document.getElementById('steplings-section');
            console.log('species section:', speciesSection);
            console.log('steplings section:', steplingsSection);
            
            if (speciesSection) speciesSection.style.display = 'none';
            if (steplingsSection) steplingsSection.style.display = 'block';
            
            log('Viewing steplings...');
            loadSteplings();
        }
        
        // Hide steplings
        function hideSteplings() {
            document.getElementById('steplings-section').style.display = 'none';
            document.getElementById('species-section').style.display = 'block';
        }
        
        // Load species
        async function loadSpecies() {
            if (!isConnected) return;
            
            try {
                var response = await fetch(API_BASE + '/api/species/all');
                if (response.ok) {
                    allSpecies = await response.json();
                    log('Loaded ' + allSpecies.length + ' species');
                    updateSpeciesGrid();
                }
            } catch (error) {
                log('Species load error: ' + error.message);
            }
        }
        
        // Load steplings
        async function loadSteplings() {
            if (!isConnected) return;
            
            try {
                var response = await fetch(API_BASE + '/api/steplings');
                if (response.ok) {
                    var result = await response.json();
                    playerSteplings = result.data || [];
                    log('Loaded ' + playerSteplings.length + ' steplings');
                    
                    // Clean up orphaned stepling IDs from training roster
                    cleanupTrainingRoster();
                    
                    updateSteplingsGrid();
                }
            } catch (error) {
                log('Steplings load error: ' + error.message);
            }
        }
        
        // Clean up orphaned stepling IDs from training roster
        function cleanupTrainingRoster() {
            var currentSteplingIds = playerSteplings.map(s => s.id);
            var originalRosterLength = game.trainingRoster.length;
            
            // Remove IDs that don't exist in current steplings
            game.trainingRoster = game.trainingRoster.filter(id => currentSteplingIds.includes(id));
            
            // Clean up roster order mapping
            var newRosterOrder = {};
            for (var i = 0; i < game.trainingRoster.length; i++) {
                var steplingId = game.trainingRoster[i];
                newRosterOrder[steplingId] = i + 1; // Re-number from 1
            }
            game.rosterOrder = newRosterOrder;
            
            if (originalRosterLength !== game.trainingRoster.length) {
                var removedCount = originalRosterLength - game.trainingRoster.length;
                log('Cleaned up ' + removedCount + ' orphaned stepling(s) from training roster');
                console.log('Training roster cleaned:', game.trainingRoster);
                console.log('New roster order:', game.rosterOrder);
            }
        }
        
        // Check milestones - independent repeating cycles for each tier
        function checkMilestones() {
            var milestones = [
                { interval: 5000, tier: 'uncommon' },
                { interval: 10000, tier: 'rare' },
                { interval: 50000, tier: 'epic' },
                { interval: 100000, tier: 'legendary' }
            ];
            
            for (var i = 0; i < milestones.length; i++) {
                var milestone = milestones[i];
                var interval = milestone.interval;
                var tier = milestone.tier;
                
                // Calculate how many times we've passed this interval
                var timesReached = Math.floor(game.steps / interval);
                
                // Count how many times we've already been awarded this tier
                var alreadyAwarded = game.milestonesReached.filter(m => m.tier === tier).length;
                
                // Award for each time we've reached this interval but haven't been awarded yet
                while (alreadyAwarded < timesReached) {
                    game.magnifyingGlass[tier]++;
                    game.milestonesReached.push({ 
                        interval: interval, 
                        tier: tier, 
                        cycle: alreadyAwarded + 1,
                        stepsWhenAwarded: game.steps
                    });
                    
                    var cycleText = alreadyAwarded > 0 ? ' (x' + (alreadyAwarded + 1) + ')' : '';
                    log('üéâ ' + interval + ' steps' + cycleText + '! Earned ' + tier + ' magnifying glass! Total: ' + getTotalGlasses());
                    alreadyAwarded++;
                }
            }
        }
        
        // Get milestone progress for display
        function getMilestoneProgress() {
            var milestones = [
                { interval: 5000, tier: 'uncommon', emoji: 'üîç' },
                { interval: 10000, tier: 'rare', emoji: 'üîé' },
                { interval: 50000, tier: 'epic', emoji: 'üî¨' },
                { interval: 100000, tier: 'legendary', emoji: 'üåü' }
            ];
            
            var progress = [];
            
            for (var i = 0; i < milestones.length; i++) {
                var milestone = milestones[i];
                var interval = milestone.interval;
                var tier = milestone.tier;
                var emoji = milestone.emoji;
                
                // Calculate progress within current cycle
                var currentCycle = Math.floor(game.steps / interval) + 1;
                var progressInCycle = game.steps % interval;
                var progressPercent = (progressInCycle / interval) * 100;
                var remaining = interval - progressInCycle;
                
                // Count how many we've earned of this tier
                var earned = Math.floor(game.steps / interval);
                
                progress.push({
                    tier: tier,
                    emoji: emoji,
                    interval: interval,
                    currentCycle: currentCycle,
                    progressInCycle: progressInCycle,
                    progressPercent: progressPercent,
                    remaining: remaining,
                    earned: earned,
                    nextTarget: currentCycle * interval
                });
            }
            
            return progress;
        }
        
        // Update milestone progress display
        function updateMilestoneDisplay() {
            var progress = getMilestoneProgress();
            var container = document.getElementById('milestone-bars');
            var html = '';
            
            for (var i = 0; i < progress.length; i++) {
                var p = progress[i];
                var tierColor = {
                    'uncommon': '#28a745',
                    'rare': '#007bff', 
                    'epic': '#6f42c1',
                    'legendary': '#ffc107'
                }[p.tier] || '#6c757d';
                
                html += '<div style="margin-bottom: 12px;">';
                html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">';
                html += '<span style="font-size: 12px; font-weight: bold;">' + p.emoji + ' ' + p.tier.toUpperCase() + '</span>';
                html += '<span style="font-size: 11px; opacity: 0.8;">' + p.earned + ' earned | ' + p.remaining.toLocaleString() + ' to go</span>';
                html += '</div>';
                
                html += '<div style="background: rgba(255,255,255,0.2); border-radius: 10px; height: 8px; overflow: hidden;">';
                html += '<div style="background: ' + tierColor + '; height: 100%; width: ' + p.progressPercent.toFixed(1) + '%; transition: width 0.3s ease;"></div>';
                html += '</div>';
                html += '</div>';
            }
            
            container.innerHTML = html;
        }
        
        // Get total magnifying glasses
        function getTotalGlasses() {
            return game.magnifyingGlass.uncommon + game.magnifyingGlass.rare + game.magnifyingGlass.epic + game.magnifyingGlass.legendary;
        }
        
        // Get best available magnifying glass tier
        function getBestGlassTier() {
            if (game.magnifyingGlass.legendary > 0) return 'legendary';
            if (game.magnifyingGlass.epic > 0) return 'epic';
            if (game.magnifyingGlass.rare > 0) return 'rare';
            if (game.magnifyingGlass.uncommon > 0) return 'uncommon';
            return null;
        }
        
        // Show magnifying glass inventory
        function showGlassInventory() {
            document.getElementById('species-section').style.display = 'none';
            document.getElementById('steplings-section').style.display = 'none';
            document.getElementById('training-roster-section').style.display = 'none';
            document.getElementById('fusion-section').style.display = 'none';
            document.getElementById('stepling-details-section').style.display = 'none';
            document.getElementById('glass-inventory-section').style.display = 'block';
            
            updateGlassInventoryGrid();
        }
        
        // Hide magnifying glass inventory
        function hideGlassInventory() {
            document.getElementById('glass-inventory-section').style.display = 'none';
            document.getElementById('species-section').style.display = 'block';
        }
        
        // Update glass inventory grid
        function updateGlassInventoryGrid() {
            var grid = document.getElementById('glass-inventory-grid');
            var html = '';
            
            var tiers = [
                { name: 'uncommon', emoji: 'üîç', color: '#28a745', description: 'Doubles advancement chances' },
                { name: 'rare', emoji: 'üîé', color: '#007bff', description: 'Quadruples lower tier chances' },
                { name: 'epic', emoji: 'üî¨', color: '#6f42c1', description: 'Massive boost to all lower tiers' },
                { name: 'legendary', emoji: 'üåü', color: '#ffc107', description: 'Ultimate discovery power' }
            ];
            
            var hasAnyGlass = false;
            
            for (var i = 0; i < tiers.length; i++) {
                var tier = tiers[i];
                var count = game.magnifyingGlass[tier.name] || 0;
                
                if (count > 0) {
                    hasAnyGlass = true;
                    var isSelected = (game.selectedGlassTier === tier.name);
                    
                    html += '<div class="card' + (isSelected ? ' selected' : '') + '" onclick="selectGlassTier(\'' + tier.name + '\')" style="border-left: 4px solid ' + tier.color + ';">';
                    html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">';
                    html += '<span style="font-size: 20px;">' + tier.emoji + '</span>';
                    html += '<span style="font-size: 18px; font-weight: bold; color: ' + tier.color + ';">√ó' + count + '</span>';
                    html += '</div>';
                    html += '<div style="font-size: 14px; font-weight: bold; margin-bottom: 4px;">' + tier.name.toUpperCase() + '</div>';
                    html += '<div style="font-size: 12px; opacity: 0.8;">' + tier.description + '</div>';
                    if (isSelected) {
                        html += '<div style="font-size: 12px; color: ' + tier.color + '; margin-top: 8px; font-weight: bold;">‚úì SELECTED</div>';
                    }
                    html += '</div>';
                }
            }
            
            if (!hasAnyGlass) {
                html = '<div class="card"><div style="text-align: center; opacity: 0.6;"><div style="font-size: 24px; margin-bottom: 8px;">üîç</div><div>No magnifying glasses yet!</div><div style="font-size: 12px; margin-top: 4px;">Earn them by reaching step milestones</div></div></div>';
            } else {
                // Add option to use no glass
                var isNoneSelected = !game.selectedGlassTier;
                html += '<div class="card' + (isNoneSelected ? ' selected' : '') + '" onclick="selectGlassTier(null)" style="border-left: 4px solid #6c757d;">';
                html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">';
                html += '<span style="font-size: 20px;">üö´</span>';
                html += '<span style="font-size: 14px; opacity: 0.8;">1% chance</span>';
                html += '</div>';
                html += '<div style="font-size: 14px; font-weight: bold; margin-bottom: 4px;">NO GLASS</div>';
                html += '<div style="font-size: 12px; opacity: 0.8;">Base discovery rates only</div>';
                if (isNoneSelected) {
                    html += '<div style="font-size: 12px; color: #6c757d; margin-top: 8px; font-weight: bold;">‚úì SELECTED</div>';
                }
                html += '</div>';
            }
            
            grid.innerHTML = html;
        }
        
        // Select glass tier for next discovery
        function selectGlassTier(tier) {
            game.selectedGlassTier = tier;
            updateGlassInventoryGrid();
            updateDisplay();
            saveGame();
            
            if (tier) {
                log('Selected ' + tier + ' magnifying glass for next discovery');
            } else {
                log('Deselected magnifying glass - using base rates');
            }
        }
        
        // Update display
        function updateDisplay() {
            document.getElementById('step-count').innerHTML = game.steps;
            document.getElementById('cells').innerHTML = game.cells;
            document.getElementById('exp').innerHTML = game.experience;
            document.getElementById('exp-bank').innerHTML = game.experienceBank;
            document.getElementById('glass').innerHTML = getTotalGlasses();
            
            // Update milestone progress
            updateMilestoneDisplay();
            
            if (game.mode === 'discovery') {
                document.getElementById('mode-title').innerHTML = 'üîç Discovery Mode';
                document.getElementById('mode-desc').innerHTML = '1000 steps = 1 cell';
            } else {
                document.getElementById('mode-title').innerHTML = 'üí™ Training Mode';
                var bankText = game.experienceBank > 0 ? ' (+' + game.experienceBank + ' banked)' : '';
                document.getElementById('mode-desc').innerHTML = '10 steps = 1 experience (' + game.trainingRoster.length + ' in roster' + bankText + ')';
            }
            
            var inspectBtn = document.getElementById('inspect-btn');
            if (game.cells >= 1 && isConnected) {
                inspectBtn.innerHTML = 'Inspect Cell (' + game.cells + ')';
                inspectBtn.disabled = false;
            } else {
                inspectBtn.innerHTML = game.cells < 1 ? 'Need 1 Cell' : 'Need Backend';
                inspectBtn.disabled = true;
            }
            
            var glassBtn = document.getElementById('glass-btn');
            var totalGlasses = getTotalGlasses();
            if (totalGlasses < 1) {
                glassBtn.disabled = true;
                glassBtn.innerHTML = 'No Glass';
            } else {
                glassBtn.disabled = false;
                if (useMagnifyingGlass) {
                    glassBtn.innerHTML = 'üîç Glass ON';
                    glassBtn.className = 'btn btn-warning';
                } else {
                    glassBtn.innerHTML = 'Use üîç Glass (' + getTotalGlasses() + ')';
                    glassBtn.className = 'btn';
                }
            }
        }
        
        // Update species grid
        function updateSpeciesGrid() {
            var grid = document.getElementById('species-grid');
            var html = '';
            
            for (var i = 0; i < allSpecies.length; i++) {
                var s = allSpecies[i];
                var discovered = s.discovered || game.discoveredSpecies.indexOf(s.id) !== -1;
                html += '<div class="card">';
                html += '<div class="emoji">' + (discovered ? s.emoji : '‚ùì') + '</div>';
                html += '<div class="name">' + (discovered ? s.name : '???') + '</div>';
                if (discovered) html += '<div style="font-size: 10px; opacity: 0.7;">' + s.rarity + '</div>';
                html += '</div>';
            }
            
            grid.innerHTML = html || '<div class="card">Loading species...</div>';
        }
        
        // Update steplings grid
        function updateSteplingsGrid() {
            var grid = document.getElementById('steplings-grid');
            var html = '';
            
            if (playerSteplings.length === 0) {
                html = '<div class="card">No steplings yet!</div>';
            } else {
                for (var i = 0; i < playerSteplings.length; i++) {
                    var s = playerSteplings[i];
                    var species = s.species || { name: 'Unknown', emoji: '‚ùì' };
                    var maxLevel = s.fusion_level * 10;
                    var isMaxLevel = s.level >= maxLevel;
                    var hasSuboptimalFusion = s.has_suboptimal_fusion || false;
                    
                    html += '<div class="card' + (isMaxLevel ? ' max-level' : '') + '" onclick="showSteplingDetails(\'' + s.id + '\')">';
                    html += '<div class="emoji">' + species.emoji + '</div>';
                    html += '<div class="name">' + species.name + (hasSuboptimalFusion ? ' ‚ö†Ô∏è' : '') + '</div>';
                    html += '<div style="font-size: 10px;">Lv.' + s.level + '/' + maxLevel + ' F.' + s.fusion_level + '</div>';
                    if (isMaxLevel) {
                        html += '<div style="font-size: 9px; color: #ffc107;">MAX LEVEL</div>';
                    }
                    if (hasSuboptimalFusion) {
                        html += '<div style="font-size: 8px; color: #ff9800;">IMPERFECT</div>';
                    }
                    html += '</div>';
                }
            }
            
            grid.innerHTML = html;
        }
        
        // Update training roster grid
        function updateTrainingRosterGrid() {
            console.log('updateTrainingRosterGrid called');
            console.log('playerSteplings:', playerSteplings.length);
            console.log('game.trainingRoster:', game.trainingRoster);
            console.log('game.rosterOrder:', game.rosterOrder);
            
            var grid = document.getElementById('training-roster-grid');
            if (!grid) {
                console.error('training-roster-grid element not found!');
                return;
            }
            
            var html = '';
            
            if (playerSteplings.length === 0) {
                html = '<div class="card">No steplings yet!</div>';
            } else {
                for (var i = 0; i < playerSteplings.length; i++) {
                    var s = playerSteplings[i];
                    var species = s.species || { name: 'Unknown', emoji: '‚ùì' };
                    var maxLevel = s.fusion_level * 10;
                    var isMaxLevel = s.level >= maxLevel;
                    var hasSuboptimalFusion = s.has_suboptimal_fusion || false;
                    var isSelected = game.trainingRoster.indexOf(s.id) !== -1;
                    var orderNumber = game.rosterOrder[s.id] || '';
                    
                    var cardClass = 'card';
                    if (isSelected) cardClass += ' selected';
                    if (isMaxLevel) cardClass += ' max-level';
                    
                    html += '<div class="' + cardClass + '" onclick="toggleSteplingInRoster(\'' + s.id + '\')">';
                    html += '<div class="emoji">' + species.emoji + '</div>';
                    html += '<div class="name">' + species.name + (hasSuboptimalFusion ? ' ‚ö†Ô∏è' : '') + '</div>';
                    html += '<div style="font-size: 10px;">Lv.' + s.level + '/' + maxLevel + ' F.' + s.fusion_level + '</div>';
                    if (isMaxLevel) {
                        html += '<div style="font-size: 9px; color: #ffc107;">MAX LEVEL</div>';
                    }
                    if (hasSuboptimalFusion) {
                        html += '<div style="font-size: 8px; color: #ff9800;">IMPERFECT</div>';
                    }
                    if (isSelected && orderNumber) {
                        html += '<div style="font-size: 14px; margin-top: 2px; font-weight: bold; color: #4CAF50;">#' + orderNumber + '</div>';
                    }
                    html += '</div>';
                }
            }
            
            console.log('Setting grid HTML:', html.substring(0, 100) + '...');
            grid.innerHTML = html;
        }
        
        // Select stepling (show details)
        function selectStepling(steplingId) {
            showSteplingDetails(steplingId);
        }
        
        // Show stepling details
        function showSteplingDetails(steplingId) {
            console.log('showSteplingDetails called:', steplingId);
            
            var stepling = playerSteplings.find(s => s.id === steplingId);
            if (!stepling) {
                log('Stepling not found!');
                return;
            }
            
            currentSteplingId = steplingId; // Track current stepling
            
            // Hide other sections
            document.getElementById('species-section').style.display = 'none';
            document.getElementById('steplings-section').style.display = 'none';
            document.getElementById('training-roster-section').style.display = 'none';
            document.getElementById('fusion-section').style.display = 'none';
            document.getElementById('stepling-details-section').style.display = 'block';
            
            // Update details
            var species = stepling.species || { name: 'Unknown', emoji: '‚ùì', rarity: 'common' };
            var maxLevel = stepling.fusion_level * 10;
            var isMaxLevel = stepling.level >= maxLevel;
            var expNeeded = isMaxLevel ? 0 : (stepling.level * 10);
            var hasSuboptimalFusion = stepling.has_suboptimal_fusion || false;
            
            var titleText = species.emoji + ' ' + species.name + ' Details';
            if (hasSuboptimalFusion) {
                titleText += ' ‚ö†Ô∏è IMPERFECT';
            }
            
            document.getElementById('stepling-details-title').innerHTML = titleText;
            document.getElementById('stepling-emoji').innerHTML = species.emoji;
            document.getElementById('stepling-name').innerHTML = species.name + (hasSuboptimalFusion ? ' ‚ö†Ô∏è' : '');
            document.getElementById('stepling-level-info').innerHTML = 'Level ' + stepling.level + '/' + maxLevel + ' ‚Ä¢ Fusion ' + stepling.fusion_level;
            
            // Stats
            document.getElementById('stat-health').innerHTML = stepling.current_stats.health;
            document.getElementById('stat-attack').innerHTML = stepling.current_stats.attack;
            document.getElementById('stat-defense').innerHTML = stepling.current_stats.defense;
            document.getElementById('stat-special').innerHTML = stepling.current_stats.special;
            
            // Info
            document.getElementById('info-species').innerHTML = species.name;
            document.getElementById('info-rarity').innerHTML = species.rarity.charAt(0).toUpperCase() + species.rarity.slice(1);
            document.getElementById('info-max-level').innerHTML = maxLevel;
            document.getElementById('info-next-level').innerHTML = isMaxLevel ? 'MAX LEVEL' : expNeeded + ' EXP needed';
            
            // Release value
            var releaseValue = calculateReleaseValue(stepling);
            document.getElementById('info-release-value').innerHTML = releaseValue.toLocaleString() + ' EXP';
            
            // Format creation date
            var createdDate = new Date(stepling.created_at);
            var now = new Date();
            var diffMs = now - createdDate;
            var diffMins = Math.floor(diffMs / 60000);
            var timeAgo;
            
            if (diffMins < 1) {
                timeAgo = 'Just now';
            } else if (diffMins < 60) {
                timeAgo = diffMins + ' minutes ago';
            } else if (diffMins < 1440) {
                timeAgo = Math.floor(diffMins / 60) + ' hours ago';
            } else {
                timeAgo = Math.floor(diffMins / 1440) + ' days ago';
            }
            
            document.getElementById('info-created').innerHTML = timeAgo;
            
            log('Viewing details for ' + species.name + ' (Lv.' + stepling.level + ' F.' + stepling.fusion_level + ')');
        }
        
        // Calculate release experience value
        function calculateReleaseValue(stepling) {
            var base = 50;
            var levelMultiplier = stepling.level * (stepling.level + 1) / 2; // Triangular number
            var fusionMultiplier = Math.pow(2, stepling.fusion_level - 1); // 2^(fusion-1)
            
            // Rarity multiplier based on species rarity
            var rarityMultipliers = {
                'common': 1,
                'uncommon': 2,
                'rare': 4,
                'epic': 8,
                'legendary': 16
            };
            var rarityMultiplier = rarityMultipliers[stepling.species?.rarity || 'common'] || 1;
            
            return Math.floor(base * levelMultiplier * fusionMultiplier * rarityMultiplier);
        }
        
        // Confirm release stepling
        function confirmReleaseStepling() {
            var stepling = playerSteplings.find(s => s.id === currentSteplingId);
            if (!stepling) {
                log('Stepling not found!');
                return;
            }
            
            var releaseValue = calculateReleaseValue(stepling);
            var species = stepling.species || { name: 'Unknown' };
            
            var confirmMessage = 'Release ' + species.name + ' (Level ' + stepling.level + ', Fusion ' + stepling.fusion_level + ')?\n\n';
            confirmMessage += 'You will receive ' + releaseValue.toLocaleString() + ' experience points.\n\n';
            confirmMessage += 'This action cannot be undone!';
            
            if (confirm(confirmMessage)) {
                releaseStepling(stepling.id, releaseValue);
            }
        }
        
        // Release stepling for experience
        async function releaseStepling(steplingId, expValue) {
            try {
                // Call backend to remove stepling from database
                if (isConnected) {
                    var response = await fetch(API_BASE + '/api/steplings/' + steplingId + '/release', {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ experienceValue: expValue })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Backend release failed');
                    }
                    
                    var result = await response.json();
                    if (!result.success) {
                        throw new Error(result.error || 'Release failed');
                    }
                }
                
                // Remove from local collection
                playerSteplings = playerSteplings.filter(s => s.id !== steplingId);
                
                // Remove from training roster if present
                game.trainingRoster = game.trainingRoster.filter(id => id !== steplingId);
                delete game.rosterOrder[steplingId];
                
                // Add experience
                game.experience += expValue;
                
                log('Released stepling for ' + expValue.toLocaleString() + ' experience points!');
                
                // Close details and refresh displays
                hideSteplingDetails();
                updateDisplay();
                saveGame();
                
            } catch (error) {
                console.error('Error releasing stepling:', error);
                log('Failed to release stepling: ' + (error.message || 'Unknown error'));
            }
        }
        
        var currentSteplingId = null; // Track which stepling details are being shown
        }
        
        // Hide stepling details
        function hideSteplingDetails() {
            document.getElementById('stepling-details-section').style.display = 'none';
            document.getElementById('steplings-section').style.display = 'block';
        }
        
        // Save/load
        function saveGame() {
            if (typeof localStorage !== 'undefined') {
                localStorage.setItem('stepScientistsMobile', JSON.stringify(game));
            }
        }
        
        function loadGame() {
            if (typeof localStorage !== 'undefined') {
                var saved = localStorage.getItem('stepScientistsMobile');
                if (saved) {
                    var loadedGame = JSON.parse(saved);
                    // Merge with default game object to ensure all properties exist
                    game = Object.assign({
                        steps: 0,
                        mode: 'discovery',
                        cells: 0,
                        experience: 0,
                        experienceBank: 0,
                        magnifyingGlass: { uncommon: 0, rare: 0, epic: 0, legendary: 0 },
                        discoveredSpecies: [],
                        milestonesReached: [],
                        trainingRoster: [],
                        rosterOrder: {},
                        fusionSlot1: null,
                        fusionSlot2: null,
                        activeFusionSlot: 1
                    }, loadedGame);
                    
                    // Migrate old magnifying glass format (number) to new format (object)
                    if (typeof game.magnifyingGlass === 'number') {
                        var oldCount = game.magnifyingGlass;
                        game.magnifyingGlass = { uncommon: 0, rare: 0, epic: 0, legendary: 0 };
                        
                        // Give all old glasses as uncommon for simplicity
                        if (oldCount > 0) {
                            game.magnifyingGlass.uncommon = oldCount;
                            console.log('Migrated ' + oldCount + ' old magnifying glasses to uncommon tier');
                            saveGame(); // Save the migrated data
                        }
                    }
                    
                    // Ensure arrays and objects exist
                    if (!Array.isArray(game.milestonesReached)) {
                        game.milestonesReached = [];
                    }
                    if (!Array.isArray(game.trainingRoster)) {
                        game.trainingRoster = [];
                    }
                    if (!game.rosterOrder || typeof game.rosterOrder !== 'object') {
                        game.rosterOrder = {};
                    }
                    
                    log('Game loaded!');
                }
            }
        }
        
        // Log
        function log(message) {
            var logEl = document.getElementById('log');
            var time = new Date().toLocaleTimeString();
            logEl.innerHTML = '[' + time + '] ' + message;
            console.log('[Step Scientists] ' + message);
        }
        
        // Start
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>